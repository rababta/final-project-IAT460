<!DOCTYPE html>
<html>
<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/addons/p5.sound.min.js"></script>
  <style>
    body { margin: 0; overflow: hidden; background: #000; }
    #gui { 
      position: absolute; top: 10px; left: 10px; 
      color: white; background: rgba(0,0,0,0.7);
      padding: 15px; border-radius: 8px; width: 280px; z-index: 100;
      max-height: 90vh; overflow-y: auto;
    }
    .slider-container { margin: 8px 0; }
    label { display: inline-block; width: 120px; font-size: 14px; }
    input[type="range"] { width: 100px; }
    input[type="text"], input[type="file"] { width: 100%; margin-bottom: 8px; }
    button { 
      background: #444; color: white; border: none;
      padding: 6px 12px; margin: 5px 2px; border-radius: 4px; cursor: pointer;
    }
    button:hover { background: #555; }
    #startMessage { 
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      color: white; font-size: 24px; text-align: center;
    }
    .tab { display: none; }
    .tab.active { display: block; }
    .tab-buttons { display: flex; margin-bottom: 10px; }
    .tab-button {
      flex: 1; padding: 5px; background: #333; 
      border: none; color: white; cursor: pointer;
    }
    .tab-button.active { background: #555; }
  </style>
</head>
<body>
  <div id="gui">
    <div class="tab-buttons">
      <button class="tab-button active" onclick="openTab('settingsTab')">Settings</button>
      <button class="tab-button" onclick="openTab('mediaTab')">Media</button>
    </div>
    
    <div id="settingsTab" class="tab active">
      <div class="slider-container">
        <label>Formation Speed:</label>
        <input type="range" id="formationSpeed" min="1" max="100" value="50">
      </div>
      <div class="slider-container">
        <label>Bass Reactivity:</label>
        <input type="range" id="bassReact" min="0" max="100" value="80">
      </div>
      <div class="slider-container">
        <label>Treble Reactivity:</label>
        <input type="range" id="trebleReact" min="0" max="100" value="60">
      </div>
      <div class="slider-container">
        <label>Rotation Speed:</label>
        <input type="range" id="rotateSpeed" min="0" max="100" value="30">
      </div>
      <div class="slider-container">
        <label>Loop Duration (s):</label>
        <input type="range" id="loopDuration" min="5" max="120" value="30">
      </div>
      <button id="startBtn">START</button>
      <button id="resetBtn">RESET FORMATION</button>
      <button id="loopBtn">TOGGLE LOOP</button>
    </div>
    
    <div id="mediaTab" class="tab">
      <div class="slider-container">
        <label>Image URL:</label>
        <input type="text" id="imageUrl" placeholder="Paste image URL">
        <button id="loadImageBtn">LOAD IMAGE</button>
      </div>
      <div class="slider-container">
        <label>Or Upload:</label>
        <input type="file" id="imageUpload" accept="image/*">
      </div>
      <div class="slider-container">
        <label>Audio URL:</label>
        <input type="text" id="audioUrl" placeholder="Paste audio URL">
        <button id="loadAudioBtn">LOAD AUDIO</button>
      </div>
      <div class="slider-container">
        <label>Or Upload:</label>
        <input type="file" id="audioUpload" accept="audio/*">
      </div>
      <div class="slider-container">
        <label>Or Use Mic:</label>
        <button id="micBtn">USE MICROPHONE</button>
      </div>
    </div>
  </div>
  
  <div id="startMessage">CLICK START TO BEGIN</div>

  <script>
// State variables
let particles = [];
let img, sound, fft;
let isReady = false;
let formationProgress = 0;
let autoRotate = true;
let rotationSpeed = 0.03;
let isLooping = false;
let loopStartTime = 0;
let loopDuration = 30;
let usingMic = false;
let audioContext;

// Parameters
let params = {
  formationSpeed: 0.02,
  bassReact: 0.8,
  trebleReact: 0.6
};

function preload() {
  // Default assets
  img = loadImage('https://99designs-blog.imgix.net/blog/wp-content/uploads/2022/06/Starbucks_Corporation_Logo_2011.svg-e1657703028844.png?auto=format&q=60&fit=max&w=930', 
    () => console.log("Default image loaded"),
    () => console.error("Error loading default image")
  );
  sound = loadSound('https://assets.mixkit.co/active_storage/sfx/2570/2570-preview.mp3',
    () => console.log("Default audio loaded"),
    () => console.error("Error loading default audio")
  );
}

function setup() {
  createCanvas(windowWidth, windowHeight, WEBGL);
  audioContext = getAudioContext();
  
  // Setup event listeners
  setupControls();
  noStroke();
}

function setupControls() {
  // Tab system
  window.openTab = function(tabId) {
    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    document.querySelector(`.tab-button[onclick="openTab('${tabId}')"]`).classList.add('active');
  };

  // Parameter controls
  document.getElementById('formationSpeed').oninput = e => {
    params.formationSpeed = e.target.value / 2000;
  };
  document.getElementById('bassReact').oninput = e => {
    params.bassReact = e.target.value / 100;
  };
  document.getElementById('trebleReact').oninput = e => {
    params.trebleReact = e.target.value / 100;
  };
  document.getElementById('rotateSpeed').oninput = e => {
    rotationSpeed = e.target.value / 1000;
  };
  document.getElementById('loopDuration').oninput = e => {
    loopDuration = parseInt(e.target.value);
  };

  // Main buttons
  document.getElementById('startBtn').onclick = startExperience;
  document.getElementById('resetBtn').onclick = resetFormation;
  document.getElementById('loopBtn').onclick = toggleLoop;

  // Media controls
  document.getElementById('loadImageBtn').onclick = loadImageFromUrl;
  document.getElementById('imageUpload').onchange = handleImageUpload;
  document.getElementById('loadAudioBtn').onclick = loadAudioFromUrl;
  document.getElementById('audioUpload').onchange = handleAudioUpload;
  document.getElementById('micBtn').onclick = toggleMic;
}

// Media loading functions
function loadImageFromUrl() {
  let url = document.getElementById('imageUrl').value;
  if (url) {
    img = loadImage(url, 
      () => {
        console.log("Custom image loaded");
        resetFormation();
      },
      () => alert("Error loading image from URL")
    );
  }
}

function handleImageUpload(e) {
  let file = e.target.files[0];
  if (file) {
    let reader = new FileReader();
    reader.onload = function(event) {
      img = loadImage(event.target.result, 
        () => {
          console.log("Uploaded image loaded");
          resetFormation();
        },
        () => alert("Error loading uploaded image")
      );
    };
    reader.readAsDataURL(file);
  }
}

function loadAudioFromUrl() {
  let url = document.getElementById('audioUrl').value;
  if (url) {
    sound = loadSound(url, 
      () => {
        console.log("Custom audio loaded");
        if (isReady) restartAudio();
      },
      () => alert("Error loading audio from URL")
    );
  }
}

function handleAudioUpload(e) {
  let file = e.target.files[0];
  if (file) {
    let reader = new FileReader();
    reader.onload = function(event) {
      sound = loadSound(event.target.result, 
        () => {
          console.log("Uploaded audio loaded");
          if (isReady) restartAudio();
        },
        () => alert("Error loading uploaded audio")
      );
    };
    reader.readAsDataURL(file);
  }
}

function toggleMic() {
  usingMic = !usingMic;
  if (usingMic) {
    sound = new p5.AudioIn();
    sound.start(() => {
      console.log("Microphone activated");
      if (isReady) restartAudio();
    });
    document.getElementById('micBtn').textContent = "DISABLE MIC";
  } else {
    if (sound && sound.stop) sound.stop();
    document.getElementById('micBtn').textContent = "USE MICROPHONE";
  }
}

function restartAudio() {
  if (sound && sound.isPlaying()) {
    sound.stop();
    sound.play();
  }
}

function toggleLoop() {
  isLooping = !isLooping;
  loopStartTime = millis();
  document.getElementById('loopBtn').textContent = isLooping ? "LOOPING ON" : "LOOPING OFF";
}

function startExperience() {
  userStartAudio().then(() => {
    if (usingMic) {
      fft = new p5.FFT();
      fft.setInput(sound);
    } else {
      sound.loop();
      fft = new p5.FFT();
    }
    initParticles();
    isReady = true;
    document.getElementById('startMessage').style.display = 'none';
    loopStartTime = millis();
  });
}

function resetFormation() {
  formationProgress = 0;
  initParticles();
  loopStartTime = millis();
}

function initParticles() {
  if (!img) return;
  
  img.loadPixels();
  particles = [];
  
  // Create particles at target positions
  for (let y = 0; y < img.height; y += 5) {
    for (let x = 0; x < img.width; x += 5) {
      let idx = (x + y * img.width) * 4;
      let brightness = img.pixels[idx];
      if (brightness > 50) {
        // Target position in 3D space
        let target = createVector(
          (x - img.width/2) * 0.8,
          (y - img.height/2) * 0.8,
          0
        );
        
        // Start position - spawn from random 3D directions
        let startPos = p5.Vector.random3D().mult(random(500, 1000));
        
        particles.push({
          pos: startPos,
          target: target,
          color: [
            150 + brightness * 0.4,
            150 + brightness * 0.4,
            255 - brightness * 0.5
          ],
          size: map(brightness, 0, 255, 2, 6),
          speed: random(0.5, 1.5),
          offset: random(0.3)
        });
      }
    }
  }
}

function draw() {
  background(0);
  
  if (!isReady) return;

  // Handle looping
  if (isLooping && millis() - loopStartTime > loopDuration * 1000) {
    resetFormation();
  }

  // Audio analysis
  let spectrum, bass = 0, treble = 0;
  if (fft) {
    spectrum = fft.analyze();
    bass = fft.getEnergy("bass");
    treble = fft.getEnergy("treble");
  }
  
  // Auto-rotation
  if (autoRotate) {
    rotateY(frameCount * rotationSpeed);
    rotateX(sin(frameCount * 0.01) * 0.2);
  }
  
  // Update formation
  if (formationProgress < 1) {
    formationProgress += params.formationSpeed;
  }
  
  // Lighting
  ambientLight(60);
  pointLight(255, 255, 255, 0, 0, 300);
  
  // Draw particles
  for (let p of particles) {
    // Animate formation
    let t = max(0, min(1, (formationProgress - p.offset) / (1 - p.offset)));
    if (t > 0) {
      p.pos.lerp(p.target, t * 0.1 * p.speed);
    }
    
    // Audio reactions
    let bassEffect = 1 + (bass/255) * params.bassReact;
    let trebleEffect = (treble/255) * params.trebleReact * 10;
    
    push();
    translate(
      p.pos.x + random(-trebleEffect, trebleEffect),
      p.pos.y + random(-trebleEffect, trebleEffect),
      p.pos.z + sin(frameCount * 0.05) * bassEffect * 5
    );
    
    // Size pulses with bass
    fill(p.color[0], p.color[1], p.color[2], 220);
    sphere(p.size * bassEffect);
    
    pop();
  }
}

function mouseDragged() {
  rotateY((pmouseX - mouseX) * 0.01);
  rotateX((pmouseY - mouseY) * 0.01);
  autoRotate = false;
}

function keyPressed() {
  if (key === 'r') autoRotate = !autoRotate;
  if (key === 'l') toggleLoop();
}

function windowResized() {
  resizeCanvas(windowWidth, windowHeight);
}
  </script>
</body>
</html>